<!doctype html>
<html>
<head>
  <script src="https://cdn.firebase.com/js/client/1.1.1/firebase.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
</head>
<body>
  <div id='messagesDiv'></div>
  <input type='text' id='nickfield' placeHolder='nickname'>
  <button onclick="createUser()">Create New User</button><br>
  <input type='text' id='username' placeHolder='Key'>
  <button onclick="login()">Log In</button></br>
  <button onclick="deleteTable()">Delete All Values</button>
  <br><br>
  <div id='currentUserDisplay'></div><br>
  <div id='meanDisplay'></div><br>
  <input type='text' id='rating' placeHolder='Goodness of Presenter'>
  <script>

  // Prototype 
  var myDataRef = new Firebase('https://gnstanley1111.firebaseio.com/');
  // User that the client is judging.
  var curUserID = null;
  var frequency = 2000; // in milliseconds
  var myInterval = 0; // necessary to loop
  $('#rating').keypress(function (e) {
    if (e.keyCode == 13) {
      var rating = parseInt($('#rating').val(),10);
      var userRef = myDataRef.child('users/'+curUserID);
      var N = 0;
      // TODO: CONCURRENCCYYY
      // Is there a way around this? 
      // I think nesting the following three works...
      userRef.child('N').once('value', function (snap) {
        N = parseInt(snap.val(),10);
      });
      // The following two happen atomically, but there can be issues
      // if something occurs between them.
      userRef.child('mean').transaction(function (u) {
        var uFloat = parseFloat(u);
        return (uFloat * N + rating) / (N+1);
      });
      userRef.child('N').transaction(function (n) {
        return parseInt(n,10)+1;
      });
    }
  });
  startloop();
  // Loops forever, every frequency milliseconds
  function startloop() {
    if (myInterval > 0) clearInterval(myInterval);
    myInterval = setInterval("getLatestMean()", frequency);
  };
  function getLatestMean() {
    if (curUserID !== null) {
      var meanRef = myDataRef.child('users/'+curUserID+'/mean');
      var nRef = myDataRef.child('users/'+curUserID+'/N');
      // Display the mean
      meanRef.once('value', function (snap) {
        var u = snap.val();
        console.log(u);
        var display = document.getElementById('meanDisplay');
        display.textContent = u;
      });
      // Set mean, n to empty
      // TODO: currently keeps it the same for debugging
      meanRef.transaction(function (l) {
        return l;
      });
      nRef.transaction(function (l) {
        return l;
      });
    }
    // Start loop again.
    startloop();
  };
  // Saves data on authentication
  myDataRef.onAuth(function(authData) {
    if (authData) {
      // Save user.
      myDataRef.child('users').child(authData.uid).set(authData);
      // Start empty 'queue'.
      myDataRef.child('users').child(authData.uid).update({'mean': 0});
      myDataRef.child('users').child(authData.uid).update({'N': 0});
    } else{
      console.log("Error, no authdata");
    }
  });
  // Delete everything, for debugging purposes.
  function deleteTable() {
    myDataRef.remove()
  };
  // TODO: Update so we can't create multiple, same user (overwriting).
  // Creates user with nickname, has a directory of nicknames and a 
  // standard user directory. The nicknames care the keys and the 
  // values are the uids
  function createUser() { 
    var nickname = $('#nickfield').val();
    myDataRef.authAnonymously(function(err,authData) {
      if (authData) {
        myDataRef.child('users').child(authData.uid).update(
          {'nickname': nickname});
        myDataRef.child('nicks').child(nickname).update(
          {'nickname': authData.uid});
        window.alert("Don't lose your username! It's " + nickname);
      } else {
        window.alert(err);
      }
    }, {remember: "sessionOnly"}
    );
  };
  // TODO: Throw error when username not found, it doesn't seem to work now.
  function login() {
    var nickname = $('#username').val();
    var nicksRef = myDataRef.child('nicks');
    var usersRef = myDataRef.child("users");
    nicksRef.child(nickname).child('nickname').once('value', function (snap) {
      var exists = (snap.val() !== null);
      if (exists){
        userID = snap.val();
        usersRef.child(userID).once('value', function(snapshot) {
          if (snap.val() !== null) {
            console.log("Found you!");
            curUserID = userID;
            var display = document.getElementById('currentUserDisplay');
            display.textContent = nickname;
          } else {
            window.alert("Sorry, that username was not found.");
          }
        });
      }
    });
  };
  </script>
</body>
</html>
